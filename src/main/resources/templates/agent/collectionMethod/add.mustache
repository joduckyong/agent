{{>layout/header}}
<style type="text/css">
.left_tbl tr:hover { 
	background-color: #ffffe0 !important;
	cursor : pointer;
}
.left_tbl tr.on {
	background-color: #ffffe0 !important;
}
</style>

        <div class="right_col" role="main">
        <form name="form1" id="form1">
          <div class="row">
            <div class="col-md-12">
              <div class="x_panel">
              	<div class="x_title"> 
                  <h2>HOME > 데이터 수집 방식 관리 > 신규등록</h2>
                  <div class="clearfix"> </div>
                </div>
                <div class="x_content"> <br>
	                <div class="border_rows">
	                  <div class="row">
	                    <div class="form-group row col-12 col-md-6">
	                      <div class="control-label">수집방식</div>
	                      <div class="form-control_box">
	                        <select class="form-control" id="method_cd" name="method_cd">
	                            <option value="A01002">FILE</option>
	                            <option value="A01001">Database</option>
	                          </select>
	                      </div>
	                    </div>
	                    <div class="form-group row col-12 col-md-6">
	                      <div class="control-label">수집방식명</div>
	                      <div class="form-control_box">
	                        <input class="form-control" type="text" name="method_nm" id="method_nm" placeholder="수집방식명을 입력하세요">
	                      </div>
	                    </div>
	                  </div>
	                </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="x_panel"> 
                <div class="x_content"> <br>
                	<div id="f_layer">
	                  <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">파일경로</div>
	                        <div class="form-control_box">
	                          <input class="form-control" type="text" name="file_path" id="file_path" placeholder="파일경로를 입력하세요">
	                        </div>
	                      </div>
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">Bypass여부</div>
	                        <div class="form-control_box" style="text-align: center;">
	                          <div class="radio radio_inline" style="padding-right: 70px; font-size: 20px;">
	                            <label>
	                              <input type="radio" id="bypass_yn1" name="bypass_yn" value="Y" checked style="width: 15px; height: 15px;">YES
	                            </label>
	                          </div>
	                          <div class="radio radio_inline" style="font-size: 20px;">
	                            <label>
	                              <input type="radio" id="bypass_yn2" name="bypass_yn" value="N" style="width: 15px; height: 15px;">NO
	                            </label>
	                          </div>
	                        </div>
	                      </div>
	                    </div>
	                    <div class="row" id="f_layer2" style="display: none;">
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">확장자</div>
	                        <div class="form-control_box">
	                          <select class="form-control" name="file_ext" id="file_ext">
	                              <option value="A06001">csv</option>
	                              <option value="A06002">xlsx</option>
	                              <option value="A06003">txt</option>
	                            </select>
	                        </div>
	                      </div>
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">구분자</div>
	                        <div class="form-control_box">
	                          <select class="form-control" name="file_delimiter" id="file_delimiter">
	                              <option value="A07001">콤마(,)</option>
	                              <option value="A07002">탭( )</option>
	                              <option value="A07003">파이프(|)</option>
	                            </select>
	                        </div>
	                      </div>
	                    </div>
	                    <div class="row" id="f_layer3" style="display: none;">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">원천데이터 수집방식</div>
	                        <div class="form-control_box" style="text-align: center;">
	                          <div class="radio radio_inline" style="padding-right: 70px; font-size: 20px;">
	                            <label>
	                              <input type="radio" id="rsrc_clct_method1" name="rsrc_clct_method" value="REPLACE" style="width: 15px; height: 15px;">REPLACE
	                            </label>
	                          </div>
	                          <div class="radio radio_inline" style="font-size: 20px;">
	                            <label>
	                              <input type="radio" id="rsrc_clct_method2" name="rsrc_clct_method" value="APPEND" checked style="width: 15px; height: 15px;">APPEND
	                            </label>
	                          </div>
	                        </div>
	                      </div>
	                    </div>
	                  </div>
	              </div>
                  <div id="d_layer" style="display: none;">
	                  <div class="border_rows">
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">Type</div>
	                        <div class="form-control_box">
	                          <select class="form-control" name="db_type" id="db_type">
	                              <option value="A02001">PostgreSQL</option>
	                              <option value="A02002">Oracle</option>
	                              <option value="A02003">MariaDB</option>
	                              <option value="A02004">MySQL</option>
	                            </select>
	                        </div>
	                      </div>
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">Database Name</div>
	                        <div class="form-control_box">
	                        	<input class="form-control" type="text" name="db_database" id="db_database" placeholder="Database Name을 입력하세요">
	                        </div>
	                      </div>
	                    </div>
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">IP</div>
	                        <div class="form-control_box">
	                          <input class="form-control" type="text" name="db_ip" id="db_ip" placeholder="IP를 입력하세요">
	                        </div>
	                      </div>
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">Port</div>
	                        <div class="form-control_box">
	                          <input class="form-control" type="text" name="db_port" id="db_port" placeholder="Port를 입력하세요">
	                        </div>
	                      </div>
	                    </div>
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">User Name</div>
	                        <div class="form-control_box">
	                          <input class="form-control" type="text" name="db_user_nm" id="db_user_nm" placeholder="User Name을 입력하세요">
	                        </div>
	                      </div>
	                      <div class="form-group row col-12 col-md-6">
	                        <div class="control-label">Password</div>
	                        <div class="form-control_box">
	                          <input class="form-control" type="password" name="db_pwd" id="db_pwd" placeholder="Password를 입력하세요">
	                        </div>
	                      </div>
	                    </div>
	                    <div class="row">
	                      <div class="form-group row col-12 col-md-12">
	                        <div class="control-label">원천데이터 수집방식</div>
	                        <div class="form-control_box" style="text-align: center;">
	                          <div class="radio radio_inline" style="padding-right: 70px; font-size: 20px;">
	                            <label>
	                              <input type="radio" id="rsrc_clct_method3" name="rsrc_clct_method2" value="REPLACE" style="width: 15px; height: 15px;">REPLACE
	                            </label>
	                          </div>
	                          <div class="radio radio_inline" style="font-size: 20px;">
	                            <label>
	                              <input type="radio" id="rsrc_clct_method4" name="rsrc_clct_method2" value="APPEND" checked style="width: 15px; height: 15px;">APPEND
	                            </label>
	                          </div>
	                        </div>
	                      </div>
	                    </div>		                    
	                  </div>
	                  <div class="d-flex justify-content-center align-items-center mt-2"> 
	                    <button class="btn btn-primary" type="button" onclick="agentCmDbConnTest();">접속 테스트</button>
	                  </div>
	                  <div class="row">
						    <div class="metatable_box col-6">
						    	<h4 class="center_title">스키마 목록</h4>
							    <div class="form-group row">
							      <div class="table_responsive" style="height: 300px; overflow: auto">
							       <table class="table table-striped table-bordered bulk_action">
							         <thead style="text-align: center;">
							           <tr>
							             <th>스키마명</th>
							           </tr>
							         </thead>
							         <tbody class="left_tbl" id="schemaList">
							         </tbody>
							       </table>
							     </div>
								</div>
							</div>
							<div class="metatable_box col-6 col-lg-6">
								<h4 class="center_title">테이블 목록</h4>
							    <div class="form-group row">
							     <div class="table_responsive" style="height: 300px; overflow: auto">
							       <table class="table table-striped table-bordered bulk_action">
							       	 <colgroup>
		                                <col width="55px">
		                              </colgroup>
							         <thead style="text-align: center;">
							           <tr>
							             <th></th>
							             <th>테이블명</th>
							             <th>테이블 설명</th>
							           </tr>
							         </thead>
							         <tbody class=right_tbl" id="tableList">
							         </tbody>
							       </table>
							     </div>
								</div>
							</div>
						</div>
				 	</div>
                  <div class="right_btns"> 
                  	<button class="btn btn-dark" type="button" onclick="goList();">목록</button>
                    <button class="btn btn-primary" type="button" onclick="agentCmAdd();">등록</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </form>
          <input type="hidden" name="schema_nm" id="schema_nm"/>
        </div>

{{>layout/footer}}

<script>
document.title = "LX DT | 데이터 수집 방식 관리";
const url = '/agent/collectionMethod';

const methodCd1 = 'A01001';	//데이터베이스
const methodCd2 = 'A01002';	//파일

let isConnTest = false;	//데이터베이스 접속 테스트 여부

//데이터베이스 접속 테스트 초기화 
$('#db_ip, #db_port, #db_user_nm, #db_pwd').on('keyup', function(){
	isConnTest = false;
});

//수집방식 선택
$("#method_cd").on("change", function(){
	if($(this).val() == methodCd1){	//데이터베이스
		showDbLayer();
	}else{	//파일
		showFileLayer();
	}
});

//수집방식 등록
const agentCmAdd = function(){
	let method_cd = $("#method_cd option:selected").val();
	if(method_cd == methodCd1){ 	//데이터베이스
		agentCmDbAdd();
	}else{	//파일
		agentCmFileAdd();
	}
}

//데이터베이스 수집방식 등록
const agentCmDbAdd = function(){
	
	let method_nm = $('#method_nm').val();
	let db_type = $('#db_type option:selected').val();
	let db_database = $('#db_database').val();
	let db_ip = $('#db_ip').val();
	let db_port = $('#db_port').val();
	let db_user_nm = $('#db_user_nm').val();
	let db_pwd = $('#db_pwd').val();
	let schema_nm = $('#schema_nm').val();
	let rsrc_clct_method = $("input:radio[name='rsrc_clct_method2']:checked").val();
	
	let table_list = new Array();
	let chk_arr = $("input[name='table_name']:checked");
    for( var i=0; i<chk_arr.length; i++ ) {
    	let table_obj = {};
    	table_obj.tbl_nm = chk_arr[i].value;
    	table_obj.tbl_desc = chk_arr[i].dataset.desc;
    	table_list.push(table_obj);
    }
	
	if(!method_nm){
		alert('수집방식명을 입력하세요!');
        $("#method_nm").focus();
        return;
	}
	
	if(!db_database){
		alert('Database Name을 입력하세요!');
        $("#db_database").focus();
        return;
	}
	
	if(!db_ip){
		alert('IP를 입력하세요!');
        $("#db_ip").focus();
        return;
	}
	
	if(!db_port){
		alert('Port를 입력하세요!');
        $("#db_port").focus();
        return;
	}
	
	if(!db_user_nm){
		alert('User Name을 입력하세요!');
        $("#db_user_nm").focus();
        return;
	}
	
	if(!db_pwd){
		alert('Password를 입력하세요!');
        $("#db_pwd").focus();
        return;
	}
	
	if(!isConnTest){
		alert('접속 테스트를 해주세요!');
		return;
	}
	
	if(table_list.length == 0){
		alert('테이블명을 선택하세요!');
		return;
	}
	
	const data = {
   		url: '/cm/'+methodCd1+'/add',
   		user_id: 'user00',
   		db_type: db_type,
   		db_ip: db_ip,
   		db_port: db_port,
   		db_user_nm: db_user_nm,
   		db_pwd: db_pwd,
   		db_database: db_database,
   		method_cd: methodCd1,
   		method_nm: method_nm,
   		schema_nm: schema_nm,
   		rsrc_clct_method: rsrc_clct_method,
   		tbl_list: table_list,
    };
	
	if (confirm("등록 하시겠습니까?")) {
	    $.ajax({
	        type: 'POST',
	        url: url+'/agentCmDbAdd',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
	  		if(errorMsg(data)){
	  			return;  
	  		}	    	
	  		  
	    	alert("저장되었습니다.");
	    	jsList();
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });
	}
}

//파일 수집방식 등록
const agentCmFileAdd = function(){
	
	let method_nm = $('#method_nm').val();
	let file_path = $('#file_path').val();
	let bypass_yn = $("input:radio[name='bypass_yn']:checked").val();
	let rsrc_clct_method = $("input:radio[name='rsrc_clct_method']:checked").val();
	let file_ext = '';
	let file_delimiter = '';
	
	if(bypass_yn == 'N'){
		file_ext = $('#file_ext').val();
		file_delimiter = $('#file_delimiter').val();
	}
	
	if(!method_nm){
		alert('수집방식명을 입력하세요!');
        $("#method_nm").focus();
        return;
	}
	
	if(!file_path){
		alert('파일경로를 입력하세요!');
        $("#file_path").focus();
        return;
	}
	
	const data = {
   		url: '/cm/'+methodCd2+'/add',
   		user_id: 'user00',
   		method_cd: methodCd2,
   		file_path: file_path,
   		method_nm: method_nm,
   		bypass_yn: bypass_yn,
   		rsrc_clct_method: rsrc_clct_method,
   		file_ext: file_ext,
   		file_delimiter: file_delimiter,
    };
	
	if (confirm("등록 하시겠습니까?")) {
	    $.ajax({
	        type: 'POST',
	        url: url+'/agentCmFileAdd',
	        dataType: 'json',
	        contentType: 'application/json; charset-utf-8',
	        data: JSON.stringify(data)
	    }).done(function (data) {
	    	
  		  if(errorMsg(data)){
  			return;  
  		  }	    	
	    	alert("저장되었습니다.");
	    	location.href = url + "/list";
	    }).fail(function (error) {
	        alert(JSON.stringify(error));
	    });
	}
}

//데이터 베이스 접속 테스트
const agentCmDbConnTest = function(){
	let db_type = $('#db_type option:selected').val();
	let db_ip = $('#db_ip').val();
	let db_port = $('#db_port').val();
	let db_user_nm = $('#db_user_nm').val();
	let db_pwd = $('#db_pwd').val();
	
	if(!db_ip){
		alert('IP를 입력하세요!');
        $("#db_ip").focus();
        return;
	}
	
	if(!db_port){
		alert('Port를 입력하세요!');
        $("#db_port").focus();
        return;
	}
	
	if(!db_user_nm){
		alert('User Name을 입력하세요!');
        $("#db_user_nm").focus();
        return;
	}
	
	if(!db_pwd){
		alert('Password를 입력하세요!');
        $("#db_pwd").focus();
        return;
	}
	
	const data = {
   		url: '/cm/'+methodCd1+'/db/conn',
   		user_id: 'user00',
   		db_type: db_type,
   		db_ip: db_ip,
   		db_port: db_port,
   		db_user_nm: db_user_nm,
   		db_pwd: db_pwd,
    };	

    $.ajax({
        type: 'POST',
        url: url+'/agentCmDbConnTest',
        dataType: 'json',
        contentType: 'application/json; charset-utf-8',
        data: JSON.stringify(data)
    }).success(function (data) {
    	if (data != null) {
    		
  		  if(errorMsg(data)){
  			return;  
  		  }    		
    		let insertTr = "";
    		if(data.content != ""){
    			for(let idx in data.content){
    				let tableArr = JSON.stringify(data.content[idx].tbl_list);
    				tableArr = tableArr.replace(/\"/gi, "'");
    				insertTr += '<tr onclick="tableNameRendering(\''+data.content[idx].schema_nm+'\','+tableArr+');">';
    				insertTr += '	<td>'+data.content[idx].schema_nm+'</td>';
    				insertTr += '</tr>';
    			}
    			
    		}
    		$("#schemaList").html(insertTr);
    		isConnTest = true;
    	}
    }).error(function (error) {
        alert('데이터베이스에 연결할 수 없습니다.');
    });
}

//테이블명 표시
const tableNameRendering = function(schema, arr){
	$("#schema_nm").val(schema);
	let insertTr = "";
	for(let table of arr){
		insertTr += '<tr>';
		insertTr += '	<td><input name="table_name" type="checkbox" value="'+isEmpty(table.tbl_nm)+'" data-desc="'+isEmpty(table.tbl_desc)+'"></td>';
		insertTr += '	<td>'+isEmpty(table.tbl_nm)+'</td>';
		insertTr += '	<td>'+isEmpty(table.tbl_desc)+'</td>';
		insertTr += '</tr>';
	}
	
	$("#tableList").html(insertTr);
	
}

//파일 데이터 수집방식 show
const showFileLayer = function(){
	$("#f_layer").show();
 	$("#d_layer").hide();
}

//데이터베이스 데이터 수집방식 show
const showDbLayer = function(){
	$("#d_layer").show();
 	$("#f_layer").hide();
}

//데이터 수집방식 관리 목록 페이지 이동
const jsList = function(){
	let method_cd = $("#method_cd option:selected").val();
	
	let form = document.createElement('form');
	form.setAttribute('method','post');
	form.setAttribute('action', url + '/list');
	
	let input = document.createElement('input');
	input.setAttribute('type', 'hidden');
	input.setAttribute('name', 'method_cd');
	input.setAttribute('value', method_cd);
    form.appendChild(input);
    
    document.body.appendChild(form);
	form.submit();
}

//목록
const goList = function(){
	location.href = url+'/list';
}

$("input:radio[name='bypass_yn']").on("change", function(){
	if($(this).val() == 'Y'){
		$("#f_layer2").hide();
		$("#f_layer3").hide();
	}else{
		$("#f_layer2").show();
		$("#f_layer3").show();
	}
});

</script>