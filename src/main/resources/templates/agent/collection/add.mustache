{{>layout/header}}

<div class="right_col" role="main">
	<div class="row">
		<div class="col-md-12">
			<div class="x_panel">
				<div class="x_title">
					<h2>HOME > 데이터 수집 관리 > 신규등록</h2>
					<div class="clearfix"></div>
				</div>
				<div class="x_content">
					<br>
					<div class="form-horizontal form-label-left">
						<div class="row">
							<div class="form-group row col-12 col-md-6">
								<label class="control-label">수집명</label>
								<div class="form-control_box">
									<input class="form-control" type="text" name="clct_nm" id="clct_nm">
								</div>
							</div>
							<div class="form-group row col-12 col-md-6">
								<label class="control-label">보관주기</label>
								<div class="form-control_box">
									<div class="col-md-5 pl-0">
										<select class="form-control" id="storage_period_year">
										</select>
									</div>
									<div class="col-md-1 pl-0">
										<label class="control-label">년</label>
									</div>
									<div class="col-md-5 pl-0">
										<select class="form-control" id="storage_period_month">
										</select>
									</div>
									<div class="col-md-1 pl-0">
										<label class="control-label">월</label>
									</div>
								</div>
							</div>
						</div>

						<div class="row">
							<div class="form-group row col-12 col-md-12">
								<label class="control-label">수집주기</label>
								<div class="form-control_box">
									<div class="col-md-2 pl-0">
										<select class="form-control" id="clct_period_cd">
											<option value="A04001">매년</option>
											<option value="A04002">매월</option>
											<option value="A04003">매일</option>
										</select>
									</div>
									<div class="col-md-2 pl-0" id="div_month">
										<select class="form-control" id="month">
										</select>
									</div>
									<div class="col-md-2 pl-0" id="div_day">
										<select class="form-control" id="day">
										</select>
									</div>
								</div>
							</div>
						</div>
				
						<div class="row">
							<div class="form-group row col-12 col-md-6">
								<label class="control-label">수집방식</label>
								<div class="form-control_box">
									<select class="form-control" id="method_cd">
										<option value="">선택</option>
										<option value="A01002">File</option>
										<option value="A01001">DB</option>
									</select>
								</div>
							</div>
							<div class="form-group row col-12 col-md-6">
								<label class="control-label">수집방식명</label>
								<div class="form-control_box duplicate_box">
									<div class="col-md-12 pl-0">
										<select class="form-control" name="file_id" id="file_id" onchange="selAgentClctFileFilesList();">
											<option value="">선택</option>
										</select>
									</div>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="metatable_box col-12" id="divFile">
								<div class="form-group row" style="height:397px; overflow:auto">
									<label class="control-label">파일 목록</label>
									<div class="table_responsive" style="height:340px; overflow:auto" >
										<div class="x_content" >
											<table class="table table-striped" style="width: 100%" >
												<thead id="thTbFile">
													<tr>
														<th style="text-align: center;">파일명</th>
														<th style="text-align: center;">확장자</th>
														<th style="text-align: center;">크기(MB)</th>
														<th style="text-align: center;">생성일자</th>
													</tr>
												</thead>
												<tbody id="agentClctFileFilesList">
													<tr>
														<td colspan="4" style="text-align: center;">데이터가 없습니다.</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>
							
							<div class="metatable_box col-6" id="divSchema" style="display:none;">
								<div class="form-group row" >
									<div class="x_content" style="height:380px; overflow:auto">
										<div class="cont_title_box">
											<h2>테이블 목록</h2>
										</div>	
										<div class="form-control_box duplicate_box">
											<input class="form-control" type="text" name="file_nm" id="file_nm" size=6>
											<button class="btn btn-primary" onclick="fileSearch('agentCmDbList', 'file_nm');">
												<i class="glyphicon glyphicon-search"></i>
											</button>
										</div>																		
										<div class="table_responsive" style="height:185px; overflow:auto" >
											<table class="table table-striped" style="width: 100%" >
												<thead>
													<tr>
														<th style="text-align: center;">테이블명</th>
														<th style="text-align: center;">테이블 설명</th>
													</tr>
												</thead>
												<tbody id="agentCmDbList">
													<tr>
														<td style="text-align: center;">데이터가 없습니다.</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
								</div>
							</div>

							<div class="metatable_box col-5 col-lg-6" id="divSchema2" style="display:none;">
								<div class="row">
									<div class="x_content" >
										<div class="cont_title_box">
											<h2><span id="titleColnm">컬럼 목록</span></h2>
										</div>
										<div class="table_responsive" style="height:320px; overflow:auto">
											<table class="table table-striped" style="width: 100%">
												<colgroup>
												</colgroup>
												<thead>
													<tr>
														<th style='text-align: center;'><input class="" type="checkbox" id="chk_all" ></th>
														<th style='text-align: center;'>컬럼명(영문)</th>
														<th style='text-align: center;'>컬럼설명</th>
														<th style='text-align: center;'>타입</th>
														<th style='text-align: center;'>길이</th>
														<th style='text-align: center;'>NULL여부</th>
													</tr>												
												</thead>
												<tbody id="agentCmFileColsList">
													<tr>
														<td colspan="6" style="text-align: center;">데이터가 없습니다.</td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>

								</div>
							</div>
						</div>
						<div class="d-flex justify-content-center align-items-center mt-2">
							<button class="btn btn-primary" onclick="add();">등록</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

{{>layout/footer}}

<script>

let url = '/agent/collection';

let fileDbContents;
let arrData = new Array(); 

//파일/db 컬럼 정보
let colData;

//테이블 컬럼 정보
let mpColData;

let tblId = "";

var file = {
	// File 데이터 수집방식 상세조회		
    agentCmFileList : function () {
		$("#file_id").empty();
		$("#divFile").show();
		$("#divSchema").hide();
		$("#divSchema2").hide();
		
		$("#agentClctFileFilesList").empty();
		$("#agentCmFileColsList").empty();
		
		arrData = new Array();
		
        var data = {
       		url: '/cm/A01002/list',
 //      		method_nm : $("#clct_nm").val(),
       		user_id: 'user00',
        };		
        $.ajax({
            type: 'POST',
            url: url+'/agentCmFileList',
            dataType: 'json',
            contentType: 'application/json; charset-utf-8',
            data: JSON.stringify(data)
        }).done(function (data) {
        	  if (data != null) {
        		  if(data.content != ""){
	        		let selOp = '<option value="">선택</option>';  
	         		$.each(data.content, function (idx, el) {        	    	
       	 		   		selOp += '<option value='+el.file_id+'>' + el.method_nm + '</option>';
       	    		});
    	    	    $("#file_id").append(selOp);
        		  }
        	  }
        	  
        }).fail(function (error) {
            alert(JSON.stringify(error));
        });	
    },
	// 파일 데이터 수집방식 파일 목록 조회
    agentClctFileFilesList : function () { 
		if($('#file_id').val() == ''){
			alert("수집방식명을 선택학세요!");
			return;
		}
		$("#agentClctFileFilesList").empty();
        var data = {
       		url: '/clct/file/list',
       		file_id: $('#file_id').val(),
       		user_id: 'user00',
        };		
        $.ajax({
            type: 'POST',
            url: url+'/agentClctFileFilesList',
            dataType: 'json',
            contentType: 'application/json; charset-utf-8',
            data: JSON.stringify(data)
        }).done(function (data) {
        	  
        	  if (data != null) {
   		        let insertTr = "";
        	    $.each(data, function (idx, el) {
            	   	  insertTr += '<tr>';
            	   	  insertTr += '<td style="text-align:left;" >' + isEmpty(el.file_nm) + '</td>';
            	   	  insertTr += '<td style="text-align:center;" >' + isEmpty(el.file_ext) + '</td>';
            	   	  insertTr += '<td style="text-align:center;" >' + el.file_size + '</td>';
            	   	  insertTr += '<td style="text-align:center;" >' + isEmpty(el.created_date) + '</td>';
            	   	  insertTr += '</tr>';
        	    });
           	    $("#agentClctFileFilesList").append(insertTr);
           	    
        	  }
        	  
        	  
        }).fail(function (error) {
            alert("파일이 존재하지 앖습니다.");
        });		
    },
	// 파일 데이터 수집방식 컬럼 목록 조회  
    agentCmFileColsList : function (file_uniq_id) {
		$("#agentCmFileColsList").empty();
        var data = {
       		file_uniq_id: file_uniq_id,
       		url: '/cm/A01002/list/files/columns',
       		user_id: 'user00',
        };		
        $.ajax({
            type: 'POST',
            url: url+'/agentCmFileColsList',
            dataType: 'json',
            contentType: 'application/json; charset-utf-8',
            data: JSON.stringify(data)
        }).done(function (data) {
        	  // 기존테이블 데이터 지우고 행을 추가해야한다면 아래 empty() 추가
        	  
        	  if (data != null) {
        		  if(data.content != ""){  
	       		    let insertTr = "";
	        	    $.each(data.content, function (idx, el) {
	            	   	  insertTr += '<tr>';
	            	   	  insertTr += '<td><input type="checkbox" class="flat" name="col_id" value="' + el.col_id + '"></td>';
	            	   	  insertTr += '<td style="text-align:left;cursor:pointer" colspan="3" >' + el.file_col_nm + '</td>';
	            	   	  insertTr += '</tr>';
	        	    });
	          	    $("#agentCmFileColsList").append(insertTr);
        		  }
        	  }
        	  
        }).fail(function (error) {
            alert(JSON.stringify(error));
        });		
    },
	// File 데이터 수집
    agentClctFile : function () {
    	
    	var clct_period;
    	var clct_period_cd = $("#clct_period_cd").val();
    	var storage_period = $("#storage_period_year").val() + $("#storage_period_month").val();
    	
    	if($("#clct_nm").val() == ""){
    		alert("수집명을 입력해주세요!");
    		$('#clct_nm').focus();
    		return;	
    	}
    	/*
    	if($("#file_id").val() == ""){
    		alert("수집방식명을 입력해주세요!");
    		return;	
    	}
    	*/
    	
    	if(clct_period_cd === 'A04001'){
    		clct_period = $("#month").val() + $("#day").val();
    	}else if(clct_period_cd === 'A04002'){
    		clct_period = '00'+$("#day").val();
    	}else if(clct_period_cd === 'A04003'){
    		clct_period = '0000'
    	}
    	
        var data = {
       		url: '/clct/file',
       		user_id: 'user00',
       		clct_nm: $("#clct_nm").val(),
       		clct_period_cd: clct_period_cd,
       		clct_period: clct_period,
       		storage_period: storage_period,
       		method_cd: $("#method_cd").val(),
       		file_id: $('#file_id').val(),
        };		
        $.ajax({
            type: 'POST',
            url: url+'/agentClctFile',
            dataType: 'json',
            contentType: 'application/json; charset-utf-8',
            data: JSON.stringify(data)
        }).done(function (data) {
      		let message = JSON.stringify(data.message);
      		alert(message.replace(/\"/gi, ''));            	 
      		jsList();
        }).fail(function (error) {
            alert(JSON.stringify(error));
        });		
    },
	
};

var db = {
		//DB 데이터 수집방식명 조회	
	    agentCmDbMethodNmList : function () {
			$("#file_id").empty();
			$("#divFile").hide();
			$("#divSchema").show();
			$("#divSchema2").show();
			$("#agentCmDbList").empty();
			$("#agentCmFileColsList").empty();
			
			arrData = new Array();
			
	        var data = {
	       		url: '/cm/A01001/list/method/nm',
	       		user_id: 'user00',
	        };		
	        $.ajax({
	            type: 'POST',
	            url: url+'/agentCmDbMethodNmList',
	            dataType: 'json',
	            contentType: 'application/json; charset-utf-8',
	            data: JSON.stringify(data)
	        }).done(function (data) {
	        	  if (data != null) {
	        	    let selOp = '<option value="">선택</option>';  
	        	    $.each(data, function (idx, el) {
	        	    	selOp += '<option value='+el.db_id+'>' + el.method_nm + '</option>';
	        	    });
	     	     	$("#file_id").append(selOp);
	        	  }
	        	  
	        }).fail(function (error) {
	            alert(JSON.stringify(error));
	        });	
	    },		
	    //DB 데이터 수집방식의 테이블 조회
	    agentCmDbTablesList : function () {
			if($('#file_id').val() == ''){
				alert("수집방식명을 선택학세요!");
				return;
			}	    	
			$("#agentCmDbList").empty();
	        var data = {
	       		url: '/clct/db/tbl/list',
	       		db_id: $("#file_id").val(),
	       		user_id: 'user00',
	        };		
	        $.ajax({
	            type: 'POST',
	            url: url+'/agentCmDbTablesList',
	            dataType: 'json',
	            contentType: 'application/json; charset-utf-8',
	            data: JSON.stringify(data)
	        }).done(function (data) {
	        	  if (data != null) {
	         		    let insertTr = "";
	            	    $.each(data, function (idx, el) {
	                	   	  insertTr += '<tr>';
	                	   	  insertTr += '<td style="cursor:pointer" onclick=db.agentCmDbColsList("'+el.tbl_id+'");>' + el.tbl_nm + '</td>';
	                	   	  insertTr += '<td>' + isEmpty(el.tbl_desc) + '</td>';
	                	   	  insertTr += '</tr>';
	            	    });
	              	    $("#agentCmDbList").append(insertTr);
	              	    
	        	  }
	        	  
	        }).fail(function (error) {
	        	alert("파일이 존재하지 앖습니다.");
	        });	
	    },		
	    //DB 데이터 수집방식의 컬럼 조회
	    agentCmDbColsList : function (tbl_id) {
	    	tblId = tbl_id;
			$("#agentCmFileColsList").empty();
	        var data = {
	       		url: '/clct/db/col/list',
	       		tbl_id: tbl_id,
	       		user_id: 'user00',
	        };		
	        $.ajax({
	            type: 'POST',
	            url: url+'/agentCmDbColsList',
	            dataType: 'json',
	            contentType: 'application/json; charset-utf-8',
	            data: JSON.stringify(data)
	        }).done(function (data) {
	        	  if (data != null) {
	         		    let insertTr = "";
	         		 	$.each(data, function (idx, el) {
	                	   	  insertTr += '<tr>';
	                	   	  insertTr += '<td style="text-align:center;" ><input class="del-chk" type="checkbox" name="checkList" value="' + el.col_id + '" ></td>';
	                	   	  insertTr += '<td style="text-align:center;" ><span id="span_' + el.col_id + '">' + isEmpty(el.col_nm) + '</span></td>';
	                	   	  insertTr += '<td style="text-align:center;" >' + isEmpty(el.col_desc) + '</td>';
	                	   	  insertTr += '<td style="text-align:center;" >' + isEmpty(el.col_type) + '</td>';
	                	   	  insertTr += '<td style="text-align:center;" >' + isEmpty(el.col_len) + '</td>';
	                	   	  insertTr += '<td style="text-align:center;" >' + isEmpty(el.col_null_yn) + '</td>';
	                	   	  insertTr += '</tr>';
	            	    });
	              	    $("#agentCmFileColsList").append(insertTr);
	        	  }
	        	  
	        }).fail(function (error) {
	            alert(JSON.stringify(error));
	        });	
	    },		
		// DB 데이터 수집
	    agentClctDb : function () {
	    	
	    	var clct_period;
	    	var clct_period_cd = $("#clct_period_cd").val();
	    	var storage_period = $("#storage_period_year").val() + $("#storage_period_month").val();
	    	
	    	if($("#clct_nm").val() == ""){
	    		alert("수집명을 입력해주세요!");
	    		$('#clct_nm').focus();
	    		return;	
	    	}
	    	if($("#file_id").val() == ""){
	    		alert("수집방식명을 입력해주세요!");
	    		return;	
	    	}	    	
	    	if(tblId == ""){
	    		alert("테이블명을 선택해주세요!");
	    		return;	
	    	}	    	
	    	
	    	if(clct_period_cd === 'A04001'){
	    		clct_period = $("#month").val() + $("#day").val() + "0000";
	    	}else if(clct_period_cd === 'A04002'){
	    		clct_period = $("#day").val() +  "0000";
	    	}else if(clct_period_cd === 'A04003'){
	    		clct_period = "0000";
	    	}
	    	
	    	let col_list = new Array();
	    	$('input:checkbox[name=checkList]').each(function (index) {
	    		if($(this).is(":checked")==true){
		    		let data = new Object();
		    		data.col_id = $(this).val();
		    		data.col_nm = $("#span_"+$(this).val()).text();
	    	    	col_list.push(data);
	    	    }
	    	});
	    	
	        var data = {
	       		url: '/clct/db',
	       		user_id: 'user00',
	       		clct_nm: $("#clct_nm").val(),
	       		clct_period_cd: clct_period_cd,
	       		clct_period: clct_period,
	       		storage_period: storage_period,
	       		method_cd: $("#method_cd").val(),
	       		db_id: $('#file_id').val(),
	       		tbl_id: tblId,
	       		col_list: col_list,
	        };		
	        $.ajax({
	            type: 'POST',
	            url: url+'/agentClctDb',
	            dataType: 'json',
	            contentType: 'application/json; charset-utf-8',
	            data: JSON.stringify(data)
	        }).done(function (data) {
	      		let message = JSON.stringify(data.message);
	      		alert(message.replace(/\"/gi, ''));            	 
	      		jsList();
	        }).fail(function (error) {
	            alert(JSON.stringify(error));
	        });		
	    },    
}

// 수집주기 선택
$("#clct_period_cd").change(function(){
	
	if($("#method_cd").val() == 'A01002'){
	    if($(this).val() == "A04001"){
	    	$("#div_month").show();
	    	$("#div_day").show();
	    } else if($(this).val() == "A04002"){
	    	$("#div_month").hide();
	    	$("#div_day").show();
	    } else if($(this).val() == "A04003"){
	    	$("#div_month").hide();
	    	$("#div_day").hide();
	    }
	}else if($("#method_cd").val() == 'A01001'){
	    if($(this).val() == "A04001"){
	    	$("#div_month").show();
	    	$("#div_day").show();
	    } else if($(this).val() == "A04002"){
	    	$("#div_month").hide();
	    	$("#div_day").show();
	    } else if($(this).val() == "A04003"){
	    	$("#div_month").hide();
	    	$("#div_day").hide();
	    }
	}else{
	    if($(this).val() == "A04001"){
	    	$("#div_month").show();
	    	$("#div_day").show();
	    } else if($(this).val() == "A04002"){
	    	$("#div_month").hide();
	    	$("#div_day").show();
	    } else if($(this).val() == "A04003"){
	    	$("#div_month").hide();
	    	$("#div_day").hide();
	    }
	}
});

// 수집방식 선택
$("#method_cd").change(function(){
    if($(this).val() == "A01002"){
    	file.agentCmFileList();
    } else if($(this).val() == "A01001"){
    	db.agentCmDbMethodNmList();
    }else{
    	$("#file_id").empty();
    	let selOp = '<option value="">선택</option>';  
    	$("#file_id").append(selOp);
    } 
    
    $("#clct_period_cd").trigger("change");
});

//수집방식명 김색 시
const selAgentClctFileFilesList = function(){
	
	var method_cd = $("#method_cd").val();
	if(method_cd == 'A01002'){
		file.agentClctFileFilesList();
	}
	if(method_cd == 'A01001'){
		db.agentCmDbTablesList();
	}
}

// 등록
const add = function(){
	
	if($("#method_cd").val() == 'A01002'){
		file.agentClctFile();
	}else if($("#method_cd").val() == 'A01001'){
		db.agentClctDb();
	}
}

// 검색 필터
const fileSearch = function(id, nm){
  var value = $('#'+nm).val().toLowerCase(); // 입력 내용을 소문자로 전환해 value 변수에 담아
      $('#'+id+' tr').filter(function() { // 일치하는 tr 요소만 보여 줘.
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1) // 일치하는 글자 있으면
  });
}
	
//데이터 수집 관리 
const jsList = function(){
	location.href = url+'/list';
}	

//날짜 셋팅 
const selInit = function(){
	
	let selOp = '';  
	let selOp2 = '';  
	let selOp3 = '';  
    for (var i = 0; i < 13; i++) {
    	if(i < 10){
			selOp += '<option value=0'+i+'>0' + i + '</option>';
    	}else{
			selOp += '<option value='+i+'>' + i + '</option>';
    	}
    }		
    for (var i = 1; i < 13; i++) {
    	if(i < 10){
    		selOp2 += '<option value=0'+i+'>0' + i + '월</option>';
    	}else{
    		selOp2 += '<option value='+i+'>' + i + '월</option>';
    	}
    }		
    for (var i = 1; i < 31; i++) {
    	if(i < 10){
    		selOp3 += '<option value=0'+i+'>0' + i + '일</option>';
    	}else{
    		selOp3 += '<option value='+i+'>' + i + '일</option>';
    	}
    }		
	
	$("#storage_period_year").append(selOp);   	
	$("#storage_period_month").append(selOp);   	
	
	$("#month").append(selOp2);   	
	$("#day").append(selOp3);   	
}

$(document).on('click','#chk_all',function(){
  	if($('#chk_all').is(':checked')){
		$('.del-chk').prop('checked',true);
	}else{	
		$('.del-chk').prop('checked',false);
	}
});

//날짜 셋팅 
selInit();
</script>

